<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediaHub — загрузка</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      margin: 24px;
      background: #fafafa;
    }

    .wrap { max-width: 980px; margin: 0 auto; }

    .card {
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 2px 12px rgba(0,0,0,.04);
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    label {
      display: block;
      font-size: 12px;
      color: #555;
      margin-bottom: 6px;
    }

    input, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
    }

    .btn {
      padding: 10px 14px;
      border-radius: 12px;
      border: 0;
      cursor: pointer;
      background: #111;
      color: #fff;
    }

    .hint {
      font-size: 12px;
      color: #777;
      margin-top: 6px;
    }

    .err {
      background: #fff2f2;
      border: 1px solid #ffd1d1;
      color: #7d1f1f;
      padding: 10px 12px;
      border-radius: 12px;
      margin-bottom: 12px;
    }

    .list {
      margin-top: 18px;
      display: grid;
      gap: 10px;
    }

    .item {
      display: flex;
      gap: 14px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #eee;
      background: #fff;
      align-items: center;
    }

    .preview {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #eee;
      background: #f3f3f3;
      flex-shrink: 0;
    }

    video.preview {
      pointer-events: none;
    }

    .meta {
      display: grid;
      gap: 6px;
    }

    .tag {
      font-size: 12px;
      padding: 4px 8px;
      border: 1px solid #e8e8e8;
      border-radius: 999px;
      background: #f7f7f7;
      display: inline-block;
      margin-right: 4px;
    }

    .muted {
      color: #777;
      font-size: 12px;
    }

    a {
      color: #0b57d0;
      text-decoration: none;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- Загрузка -->
  <div class="card">
    <h2 style="margin:0 0 10px;">Загрузка фото / видео</h2>

    {% if form.errors %}
      <div class="err">
        {{ form.non_field_errors }}
        {% for field in form %}
          {% for error in field.errors %}
            <div>{{ field.label }}: {{ error }}</div>
          {% endfor %}
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="row">
        <div>
          <label>Тип медиа</label>
          {{ form.media_type }}
        </div>
        <div>
          <label>Источник</label>
          {{ form.source_type }}
        </div>
      </div>

      <div class="row">
        <div>
          <label>Категория</label>
          {{ form.category }}
        </div>
        <div></div>
      </div>

      <div class="row">
        <div id="file-block">
          <label>Файлы (можно выбрать несколько)</label>
          {{ form.files }}
          <div class="hint">Все файлы должны быть одного типа</div>
        </div>

        <div id="url-block">
          <label>Ссылка</label>
          {{ form.external_url }}
        </div>
      </div>

      <div class="row">
        <div>
          <label>Длительность (сек, только для video)</label>
          {{ form.duration }}
        </div>
        <div></div>
      </div>

      <div style="margin-top:14px;">
        <button class="btn" type="submit">Сохранить</button>
        <div class="hint">Фото автоматически конвертируются в WEBP</div>
      </div>
    </form>
  </div>

  <!-- Фильтр -->
  <div class="card" style="margin-top:16px;">
    <form method="get">
      <div class="row">
        <div>
          <label>Фильтр по категории</label>
          <select name="category" onchange="this.form.submit()">
            <option value="">Все категории</option>
            {% for c in categories %}
              <option value="{{ c.id }}"
                {% if selected_category == c.id|stringformat:"s" %}selected{% endif %}
              >
                {{ c.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div></div>
      </div>
    </form>
  </div>

  <!-- Список -->
  <div class="list">
    {% for m in items %}
      <div class="item">

        {% if m.media_type == "photo" and m.preview %}
          <img class="preview" src="{{ m.preview.url }}" alt="preview">

        {% elif m.media_type == "video" %}
          {% if m.file %}
            <video
              class="preview"
              src="{{ m.file.url }}"
              muted
              preload="metadata"
              playsinline
            ></video>
          {% elif m.external_url %}
            <video
              class="preview"
              src="{{ m.external_url }}"
              muted
              preload="metadata"
              playsinline
            ></video>
          {% endif %}
        {% endif %}

        <div class="meta">
          <div>
            <span class="tag">{{ m.media_type }}</span>
            <span class="tag">{{ m.source_type }}</span>
            {% if m.category %}
              <span class="tag">{{ m.category.name }}</span>
            {% endif %}
            {% if m.duration %}
              <span class="tag">{{ m.duration }} сек</span>
            {% endif %}
          </div>

          <div class="muted">#{{ m.id }} · {{ m.created_at }}</div>

          <div>
            {% if m.media_type == "photo" %}
              <a href="{% url 'view-image' m.id %}">Открыть изображение</a>
            {% elif m.media_type == "video" %}
              <a href="{% url 'view-video' m.id %}">Открыть видео</a>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <div class="card">Пока пусто</div>
    {% endfor %}
  </div>

</div>

<script>
  const source = document.getElementById("id_source_type");
  const fileBlock = document.getElementById("file-block");
  const urlBlock = document.getElementById("url-block");

  function syncFields() {
    if (!source) return;

    if (source.value === "file") {
      fileBlock.classList.remove("hidden");
      urlBlock.classList.add("hidden");
    } else {
      fileBlock.classList.add("hidden");
      urlBlock.classList.remove("hidden");
    }
  }

  source.addEventListener("change", syncFields);
  syncFields();
</script>

</body>
</html>
